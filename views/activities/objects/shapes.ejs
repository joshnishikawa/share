<%- include('../../head'); -%>

<style>
  #canvasWrapper {
    background-image: url('/image/medBG.png');
  }

  .shape {
    height: 14%;
    position: relative;
  }

  .canvas-shape {
    position: absolute;
    cursor: move;
  }

  .selected {
    filter: drop-shadow(0 0 0.5rem #0f0);
  }

  .drag-handle {
    /* use image/transfrom.svg */
    background-image: url('/image/transform.svg');
    background-size: 100%;
    background-repeat: no-repeat;
    position: absolute;
    text-shadow: 0 0 0.5rem #000;
    width: 30px;
    height: 30px;
    left: calc(50% - 15px);
    bottom: -40px;
    cursor: pointer;
  }

  #colorMenu ul li,
  #tagMenuFiller {
    font-weight: bold;
    height: 9%;
  }

  #colorMenu ul li:hover {
    cursor: pointer;
  }
</style>


<div class="container-fluid g-0">
  <div class="row g-0" style="height:100vh;">
    <div id="colorMenu" class="col ps-1 pt-1 bg-light" style="max-width:100px;">
      <ul class="nav vert-tabs d-flex flex-column" style="height:100%;">
        <li class="nav-item rounded-start p-2" style="color:white;background-color:red;">RED</li>
        <li class="nav-item rounded-start p-2" style="background-color: orange;">ORANGE</li>
        <li class="nav-item rounded-start p-2" style="background-color: yellow;">YELLOW</li>
        <li class="nav-item rounded-start p-2" style="color:white;background-color: green;">GREEN</li>
        <li class="nav-item rounded-start p-2" style="color:white;background-color: blue;">BLUE</li>
        <li class="nav-item rounded-start p-2" style="color:white;background-color: purple;">PURPLE</li>
        <li class="nav-item rounded-start p-2" style="background-color: hotpink;">PINK</li>
        <li class="nav-item rounded-start p-2 border border-end-0" style="background-color: white">WHITE</li>
        <li class="nav-item rounded-start p-2" style="color:white;background-color: black;">BLACK</li>

        
      </ul>
      <div style="position:relative;">
        <button id="manageCanvases" class="btn btn-lg btn-success mt-5 mb-1 w-100"
                style="position:absolute;bottom:0;">
          <i class="material-icons" style="font-size:2.5rem;">view_module</i>
        </button>
      </div>
    </div>

    <div id="shapeMenu" class="col bg-light p-2" style="height:100%;max-width:100px;border:10px solid rgba(0,0,0,0);">
      <div class="shape" data-shape="circle">
        <svg class="circle-svg" width="100%" height="100%" viewBox="0 0 100 100" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <circle cx="50" cy="50" r="49" fill="purple" stroke="black" stroke-width="1" />
        </svg>
      </div>
      <div class="shape" data-shape="square">
        <svg class="square-svg" width="100%" height="100%" viewBox="0 0 100 100" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <rect x="0" y="0" width="100" height="100" fill="green" stroke="black" stroke-width="1" />
        </svg>
      </div>
      <div class="shape" data-shape="triangle">
        <svg class="triangle-svg" width="100%" height="100%" viewBox="0 0 100 87" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <polygon points="50,0 100,86 0,86" fill="hotpink" stroke="black" stroke-width="1" />
        </svg>
      </div>
      <div class="shape" data-shape="rectangle">
        <svg class="rectangle-svg" width="100%" height="100%" viewBox="0 0 100 60" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <rect x="0" y="0" width="100" height="60" fill="orange" stroke="black" stroke-width="1" />
        </svg>
      </div>
      <div class="shape" data-shape="diamond">
        <svg class="diamond-svg" width="100%" height="100%" viewBox="0 0 100 80" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <polygon points="50,0 100,40 50,80 0,40" fill="blue" stroke="black" stroke-width="1" />
        </svg>
      </div>
      <div class="shape" data-shape="star">
        <svg class="star-svg" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 90 85"
          fill="none">
          <polygon points="45,0 56,30 90,30 63,52 73,85 45,65 17,85 27,52 0,30 34,30" fill="yellow" stroke="black"
            stroke-width="1" />
        </svg>
      </div>
      <div class="shape" data-shape="heart">
        <svg class="heart-svg" width="100%" height="100%" viewBox="0 0 100 100" fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <path
            d="m 29.703568,1.0010808 a 28.70313,31.396622 0 0 0 -20.2964316,9.1950552 28.70313,31.396622 0 0 0 -1e-7,44.401932 L 49.999999,99 90.592864,54.598068 a 28.70313,31.396622 0 0 0 0,-44.401932 28.70313,31.396622 0 0 0 -40.592864,0 28.70313,31.396622 0 0 0 -20.296432,-9.1950552 z"
            fill="red" stroke="black" stroke-width="1" />
        </svg>
      </div>
    </div>

    <!-- Canvas area for dragging and dropping shapes -->
    <div id="canvasWrapper" class="col" style="max-height:100vh;overflow:visible;">
      <div id="canvas" style="height:100%;overflow:visible;position:relative;"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="canvasManagerModal" tabindex="-1" aria-labelledby="canvasManagerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="canvasManagerModalLabel">Manage Canvases</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="canvasGrid" class="canvas-grid"></div>
      </div>
    </div>
  </div>
</div>

<style>
.canvas-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 200px));
  gap: 15px;
  padding: 10px;
  justify-content: center;
  max-width: calc(4 * 200px + 3 * 15px + 20px); /* 4 items + 3 gaps + padding */
  margin: 0 auto;
}

.canvas-grid-item {
  aspect-ratio: 4 / 3;
  max-width: 200px;
  border: 3px solid #ccc;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  overflow: hidden;
  position: relative;
}

.canvas-action-btn {
  background: #f8f9fa;
}

.canvas-action-btn.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#deleteCanvasBtn {
  opacity: 0.3;
  cursor: not-allowed;
}

#deleteCanvasBtn.drag-active {
  opacity: 1;
  cursor: pointer;
}

.canvas-action-btn:hover:not(.disabled) {
  border-color: #0d6efd;
  transform: scale(1.05);
}

#addCanvasBtn:hover.disabled {
  border-color: #ccc;
  transform: none;
}

#deleteCanvasBtn:hover {
  border-color: #ccc;
  transform: none;
}

#deleteCanvasBtn.drag-active:hover {
  border-color: #0d6efd;
  transform: scale(1.05);
}

#addCanvasBtn.add-active {
  border-color: #198754;
  background-color: #e6f4ea;
  transform: scale(1.1);
}

#deleteCanvasBtn.delete-active {
  border-color: #dc3545;
  background-color: #ffe6e6;
  transform: scale(1.1);
}

.canvas-snapshot {
  background: white;
  position: relative;
}

.canvas-snapshot.active {
  border-color: #0d6efd;
  border-width: 4px;
  box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
}

.canvas-snapshot:hover {
  border-color: #0d6efd;
  transform: scale(1.05);
}

.canvas-snapshot:hover.dragging,
.canvas-snapshot.no-hover:hover {
  border-color: #ccc;
  transform: none;
}

.canvas-snapshot.dragging {
  opacity: 0.3;
}

.canvas-thumbnail {
  width: 100%;
  height: 100%;
  overflow: hidden;
  position: relative;
  background: #f0f0f0;
}

.drag-clone {
  pointer-events: none;
  aspect-ratio: 4 / 3;
  width: 200px;
  background: white;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
<script src="/javascripts/canvas_builder.js"></script>
<script src="/javascripts/canvas_manager.js"></script>

<script>
$(function () {
  // Initialize canvas builder
  const canvasBuilder = new CanvasBuilder({
    storageKey: 'shapes',
    itemSelector: '.shape',
    menuContainerId: 'shapeMenu',
    canvasId: 'canvas',
    canvasItemClass: 'canvas-shape',
    colorableSelector: 'path, circle, rect, polygon',
    minScale: 0.3,
    maxScale: 3.0,
    savePromptText: "<%- __('shapesName') %>",
    enableScale: true,
    enableRotate: true,
    enableDragHandles: true,
    dragHandleShapes: ['rectangle', 'triangle', 'diamond'],
    onItemAdded: function(clone) {
      // Add drag handle for rectangle, triangle, and diamond
      if (clone.attr("data-shape") === "rectangle" || clone.attr("data-shape") === "triangle" || clone.attr("data-shape") === "diamond") {
        clone.append('<div class="drag-handle"></div>');
      }
    }
  });

  canvasBuilder.init();

  // Color menu functionality
  $('#colorMenu .nav-item').on('click', function () {
    let color = $(this).text().toLowerCase();
    color = color === "pink" ? "hotpink" : color;
    $('#shapeMenu').addClass("rounded-3").css('border', `10px solid ${color}`);
    canvasBuilder.setColorableElements(color);
  });

  // Drag handle functionality (shapes-specific)
  $(document).on("mousedown touchstart", ".drag-handle", function (e) {
    e.stopPropagation();
    const shape = $(this).closest('.canvas-shape');
    const currentAngle = canvasBuilder.getRotationAngle(shape);
    const currentScale = canvasBuilder.getScale(shape);
    const currentHeight = shape.height();
    const startWidth = shape.width();
    startDrag(e, currentAngle, currentScale, currentHeight, startWidth);
  });

  function startDrag(e, currentAngle, currentScale, currentHeight, startWidth) {
    e.preventDefault();
    canvasBuilder.setIsDraggingHandle(true);
    const shape = e.target.closest('.canvas-shape');
    $(document).on('mousemove touchmove', drag);
    $(document).on('mouseup touchend', stopDrag);

    const shapeBounds = shape.getBoundingClientRect();
    let shapeCenter = {
      x: shapeBounds.left + shapeBounds.width / 2,
      y: shapeBounds.top + shapeBounds.height / 2
    };

    const initialAngle = e.type === 'mousedown' 
      ? Math.atan2(e.clientX - shapeCenter.x, -(e.clientY - shapeCenter.y)) * (180 / Math.PI)
      : Math.atan2(e.touches[0].clientX - shapeCenter.x, -(e.touches[0].clientY - shapeCenter.y)) * (180 / Math.PI);

    function drag(e) {
      e.preventDefault();
      
      const deltaX = e.type === 'mousemove' ? e.clientX - shapeCenter.x : e.touches[0].clientX - shapeCenter.x;
      const deltaY = e.type === 'mousemove' ? e.clientY - shapeCenter.y : e.touches[0].clientY - shapeCenter.y;
      const angle = Math.atan2(deltaX, -(deltaY)) * (180 / Math.PI);
      const newRotation = angle - initialAngle;
      const distance = 2 * Math.sqrt(deltaX * deltaX + deltaY * deltaY);
      currentHeight = distance / currentScale;

      shape.style.transformOrigin = 'center center';
      shape.style.transform = `scale(${currentScale}) rotate(${currentAngle + newRotation}deg)`;
      shape.style.height = `${currentHeight}px`;
      shape.style.width = `${startWidth}px`;

      const svg = shape.querySelector('svg');
      const polygon = svg.querySelector('polygon');
      const rect = svg.querySelector('rect');

      svg.setAttribute('viewBox', `0 0 ${startWidth} ${currentHeight}`);
      shape.setAttribute('height', currentHeight);

      if (shape.getAttribute("data-shape") === "triangle") {
        polygon.setAttribute('points', `${startWidth / 2},0 ${startWidth},${currentHeight} 0,${currentHeight}`);
      } else if (shape.getAttribute("data-shape") === "diamond") {
        polygon.setAttribute('points', `${startWidth / 2},0 ${startWidth},${currentHeight / 2} ${startWidth / 2},${currentHeight} 0,${currentHeight / 2}`);
      } else {
        rect.setAttribute('height', currentHeight);
        rect.setAttribute('width', startWidth);
      }

      const newTop = shapeCenter.y - currentHeight / 2;
      shape.style.top = `${newTop}px`;
      
      const updatedBounds = shape.getBoundingClientRect();
      shapeCenter = {
        x: updatedBounds.left + updatedBounds.width / 2,
        y: updatedBounds.top + updatedBounds.height / 2
      };
    }

    function stopDrag() {
      $(document).off('mousemove touchmove', drag);
      $(document).off('mouseup touchend', stopDrag);
      
      const matrix = new DOMMatrix(getComputedStyle(shape).transform);
      currentAngle = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
      
      const dragHandle = $(shape).find('.drag-handle');
      if (dragHandle.length > 0) {
        dragHandle.css({
          transform: `scale(${1 / currentScale})`
        });
      }
      
      canvasBuilder.setIsDraggingHandle(false);
      canvasBuilder.saveToStorage();
    }
  }
});
</script>

<%- include('../../foot'); -%>